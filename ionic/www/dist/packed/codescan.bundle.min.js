angular.module("starter").controller("CodeScanController",function($cordovaBarcodeScanner,$cordovaClipboard,$ionicHistory,LinkService,$scope,$state,$window,$rootScope,Dialog,Discount,SB){$scope.scanProtocols=["tel:","http:","https:","geo:","sms:","smsto:","mailto:","ctc:"],$scope.is_protocol_found=!1,$cordovaBarcodeScanner.scan().then(function(scannedData){if($ionicHistory.goBack(),!scannedData.cancelled&&""!==scannedData.text){var scannedText=scannedData.text.toLowerCase().split(":")[0]+":";if(-1!==$scope.scanProtocols.indexOf(scannedText)){var contentUrl=scannedData.text;if("geo:"===scannedText){var coords=scannedText.replace("geo:","").split(",");return void Navigator.navigate({lat:coords[0],lng:coords[1]})}DEVICE_TYPE===SB.DEVICE.TYPE_IOS&&"smsto:"===$scope.scanProtocols[i]&&(contentUrl=contentUrl.replace(/(smsto):/i,"sms:").replace(/([0-9]):(.*)/,"$1")),LinkService.open(contentUrl,{global:{browser:"external_browser"}})}else{var qrCode=scannedData.text.replace("sendback:","");Discount.isQrCode(qrCode).then(function(payload){Discount.setValueId(payload.value_id),Discount.unlockByQRCode(payload.qr_code).then(function(unlockPayload){Dialog.alert("Thanks","You have successfully unlocked a coupon.","OK",2350,"codescan").then(function(){$state.go("discount-view",{value_id:payload.value_id,promotion_id:payload.promotion_id})})},function(data){})},function(error){}),Padlock.isQrCode(qrCode).then(function(payload){Padlock.unlockByQRCode(payload.qr_code).then(function(unlockPayload){Padlock.unlocked_by_qrcode=!0,$window.localStorage.setItem("sb-uc",payload.qr_code),$rootScope.$broadcast(SB.EVENTS.PADLOCK.unlockFeatures),Dialog.alert("Thanks","You have successfully unlocked features.","OK",2350,"codescan").then(function(){$ionicHistory.clearHistory(),$state.go("home")})},function(data){})},function(error){});var text=scannedData.text;Dialog.confirm("Result",text,["COPY","DONE"],"text-center","codescan").then(function(result){result&&$cordovaClipboard.copy(scannedData.text).then(function(){},function(){})})}}},function(error){$ionicHistory.goBack(),Dialog.alert("Error","An error occurred while reading the code.","OK",-1,"codescan")})});